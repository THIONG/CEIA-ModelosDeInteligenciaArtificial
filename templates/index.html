<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chuma AI</title>
    <link rel="icon" type="image/x-icon" href="https://chat.deepseek.com/favicon.svg">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="{{ url_for('static', filename='js/marked.min.js') }}"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <style>
        body {
            font-family: "Poppins", sans-serif;
            margin: 0;
            padding: 0;
            background-color: #292a2d;
            color: #d0d0d0;
        }
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .header {
            background-color: #292a2d;
            padding: 20px 20px;
            position: sticky;
            top: 0;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            margin: 0;
            font-size: 20px;
        }
        .header button {
            background-color: #4d6bfe;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .header button:hover {
            background-color: #3a5bbf;
        }
        .chat-container {
            flex: 1;
            position: relative;
            background-color: #292a2d;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }
        .chat-container::before,
        .chat-container::after {
            content: "";
            position: fixed;
            left: 0;
            right: 0;
            height: 80px;
            pointer-events: none;
            z-index: 2;
        }
        .chat-container::before {
            top: 60px;
            background: linear-gradient(to bottom, 
                rgba(41,42,45,1) 0%, 
                rgba(41,42,45,0.8) 50%,
                rgba(41,42,45,0) 100%);
        }
        .chat-container::after {
            bottom: 90px;
            background: linear-gradient(to top, 
                rgba(41,42,45,1) 0%, 
                rgba(41,42,45,0.9) 30%,
                rgba(41,42,45,0) 100%);
        }
        .chat-box {
            height: calc(100vh - 20px - 120px);
            overflow-y: auto;
            padding: 40px 15px 90px;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .chat-box::-webkit-scrollbar {
            display: none;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
            max-width: 75%;
            word-wrap: break-word;
        }
        .user-message {
            background-color: #4d6bfe;
            color: white;
            align-self: flex-end;
            border-radius: 20px 20px 5px 20px;
            padding: 8px 15px;
            max-width: 70%;
            line-height: 1.3;
            margin: 8px 0;
        }
        .bot-message {
            background-color: transparent;
            color: #d0d0d0;
            align-self: flex-start;
        }
        .thinking-message {
            display: flex;
            align-items: center;
            background-color: #444654;
            padding: 15px 20px;
            border-radius: 8px;
            margin: 10px 0;
            max-width: 800px;
        }
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #4d6bfe;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
            margin-right: 12px;
            flex-shrink: 0;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .input-area {
            padding: 10px;
            background-color: #292a2d;
            position: sticky;
            bottom: 0;
            z-index: 10;
            box-shadow: 0 -10px 15px #292a2d;
        }
        .input-wrapper {
            position: relative;
            display: flex;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }
        textarea {
            width: 100%;
            min-height: 50px;
            max-height: 200px;
            padding: 10px 60px 10px 15px;
            border-radius: 25px;
            border: 1px solid #666;
            resize: none;
            overflow-y: hidden;
            font-size: 18px;
            background-color: #404045;
            color: white;
            box-sizing: border-box;
            transition: height 0.2s ease;
            line-height: 50px;
            caret-color: white;
        }
        textarea.empty {
            caret-color: transparent;
        }
        .placeholder-label {
            position: absolute;
            top: 50%;
            left: 15px;
            transform: translateY(-50%);
            pointer-events: none;
            color: #aaa;
            font-weight: 500;
            transition: opacity 0.2s;
        }
        .info-text {
            font-size: 12px;
            color: #aaa;
            text-align: center;
            margin-top: 5px;
        }
        button#sendButton {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background-color: #4d6bfe;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        button#sendButton:hover {
            background-color: #3a5bbf;
        }
        pre {
            background-color: #1e1e1e;
            color: #f8f8f2;
            padding: 0;
            border-radius: 5px;
            border: 1px solid #444;
            overflow: hidden;
            font-size: 12px !important;
            font-family: "Courier New", monospace;
            margin: 10px 0;
            position: relative;
        }
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #2d2d2d;
            padding: 8px 10px;
            border-bottom: 1px solid #444;
        }
        .language-label {
            color: #8da2fb;
            font-size: 0.85em;
            text-transform: uppercase;
            font-weight: 600;
        }
        .copy-button {
            background-color: #4d6bfe;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background-color 0.2s;
        }
        .copy-button:hover {
            background-color: #3a5bbf;
        }
        pre code {
            display: block;
            padding: 12px;
            overflow-x: auto;
            font-size: 12px !important;
            line-height: 1.4 !important;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <h1>Chuma AI</h1>
            <button onclick="clearChat()">Reset Chat</button>
        </header>
        <div class="chat-container">
            <div class="chat-box" id="chatBox"></div>
        </div>
        <div class="input-area">
            <div class="input-wrapper">
                <textarea id="messageInput" class="empty"></textarea>
                <label for="messageInput" class="placeholder-label">Envía un mensaje a ChumaAI</label>
                <button id="sendButton" onclick="sendMessage()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24">
                        <path d="M7 7h8.586L5.293 17.293l1.414 1.414L17 8.414V17h2V5H7v2z"/>
                    </svg>
                </button>
            </div>
            <p class="info-text">ChumaAI puede cometer errores. Considera verificar la información importante.</p>
        </div>
    </div>

    <script>
        const textarea = document.getElementById("messageInput");
        const placeholderLabel = document.querySelector(".placeholder-label");
        const minHeight = 50;
        let currentMaxHeight = minHeight;

        textarea.style.height = minHeight + "px";
        textarea.style.lineHeight = "50px";

        textarea.addEventListener("input", function () {
            if (this.value.trim() === "") {
                this.classList.add("empty");
            } else {
                this.classList.remove("empty");
            }
            this.style.height = minHeight + "px";
            const newHeight = this.scrollHeight;
            if (newHeight > currentMaxHeight) {
                currentMaxHeight = newHeight;
                this.style.height = newHeight + "px";
            } else {
                this.style.height = currentMaxHeight + "px";
            }
            placeholderLabel.style.opacity = this.value ? "0" : "1";
        });

        textarea.addEventListener("blur", function () {
            if (!this.value.trim()) {
                currentMaxHeight = minHeight;
                this.style.height = minHeight + "px";
                this.style.lineHeight = "50px";
                placeholderLabel.style.opacity = "1";
                this.classList.add("empty");
            }
        });

        textarea.addEventListener("keypress", function (event) {
            if (event.key === "Enter" && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });

        async function sendMessage() {
            const chatBox = document.getElementById("chatBox");
            const messageText = textarea.value.trim();
            if (!messageText) return;

            const userMessage = document.createElement("div");
            userMessage.className = "message user-message";
            const codeRegex = /```(\w+)?\s*([\s\S]*?)```/gi;
            let formattedUserMessage = messageText;
            formattedUserMessage = formattedUserMessage.replace(
                codeRegex,
                (match, lang, code) => `
                    <pre>
                        <div class="code-header">
                            <span class="language-label">${(lang || 'text').toUpperCase()}</span>
                            <button class="copy-button">Copiar</button>
                        </div>
                        <code class="language-${lang || 'text'}">${DOMPurify.sanitize(code)}</code>
                    </pre>`
            );
            userMessage.innerHTML = DOMPurify.sanitize(marked.parse(formattedUserMessage));

            userMessage.querySelectorAll(".copy-button").forEach((copyBtn) => {
                copyBtn.onclick = () => {
                    const codeContent = copyBtn.closest("pre").querySelector("code").textContent;
                    navigator.clipboard.writeText(codeContent).then(() => {
                        copyBtn.textContent = "¡Copiado!";
                        setTimeout(() => (copyBtn.textContent = "Copiar"), 2000);
                    });
                };
            });

            Prism.highlightAllUnder(userMessage);
            chatBox.appendChild(userMessage);

            // Mensaje de pensamiento actualizado
            const thinkingMessage = document.createElement("div");
            thinkingMessage.className = "message bot-message thinking-message";
            thinkingMessage.innerHTML = `
                <div class="spinner"></div>
                <span>Chuma está pensando...</span>
            `;
            chatBox.appendChild(thinkingMessage);

            textarea.value = "";
            placeholderLabel.style.opacity = "1";
            currentMaxHeight = minHeight;
            textarea.style.height = minHeight + "px";
            textarea.style.lineHeight = "50px";
            textarea.classList.add("empty");
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                const response = await fetch("http://127.0.0.1:5000/get-response", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: messageText }),
                });
                if (!response.ok) throw new Error(`Error: ${response.status}`);
                const data = await response.json();

                thinkingMessage.remove();

                const botMessage = document.createElement("div");
                botMessage.className = "message bot-message";
                const thinkRegex = /<think>([\s\S]*?)<\/think>/gi;
                let thinkContent = "";
                const cleanReply = data.reply.replace(thinkRegex, (match, content) => {
                    thinkContent += DOMPurify.sanitize(marked.parse(content));
                    return "";
                });

                const formattedReply = cleanReply.replace(codeRegex, (match, lang, code) =>
                    `<pre>
                        <div class="code-header">
                            <span class="language-label">${(lang || 'text').toUpperCase()}</span>
                            <button class="copy-button">Copiar</button>
                        </div>
                        <code class="language-${lang || 'text'}">${DOMPurify.sanitize(code)}</code>
                    </pre>`
                );

                botMessage.innerHTML = DOMPurify.sanitize(marked.parse(formattedReply));

                if (thinkContent) {
                    const thinkContainer = document.createElement("div");
                    thinkContainer.innerHTML = `
                        <button class="reasoning-toggle">▼ Mostrar razonamiento</button>
                        <div class="reasoning-content">${thinkContent}</div>
                    `;
                    botMessage.appendChild(thinkContainer);
                    const toggleBtn = thinkContainer.querySelector(".reasoning-toggle");
                    const contentDiv = thinkContainer.querySelector(".reasoning-content");
                    toggleBtn.addEventListener("click", () => {
                        contentDiv.classList.toggle("expanded");
                        toggleBtn.textContent = contentDiv.classList.contains("expanded")
                            ? "▲ Ocultar razonamiento"
                            : "▼ Mostrar razonamiento";
                    });
                }

                botMessage.querySelectorAll(".copy-button").forEach((copyBtn) => {
                    copyBtn.onclick = () => {
                        const codeContent = copyBtn.closest("pre").querySelector("code").textContent;
                        navigator.clipboard.writeText(codeContent).then(() => {
                            copyBtn.textContent = "¡Copiado!";
                            setTimeout(() => (copyBtn.textContent = "Copiar"), 2000);
                        });
                    };
                });

                Prism.highlightAllUnder(botMessage);
                chatBox.appendChild(botMessage);
            } catch (error) {
                console.error("Error:", error);
                const errorMessage = document.createElement("div");
                errorMessage.className = "message bot-message";
                errorMessage.textContent = "Error al obtener respuesta. Intenta de nuevo.";
                chatBox.appendChild(errorMessage);
            }

            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function clearChat() {
            const chatBox = document.getElementById("chatBox");
            try {
                const response = await fetch("http://127.0.0.1:5000/reset", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" }
                });
                if (!response.ok) throw new Error(`Error: ${response.status}`);
                const data = await response.json();
                chatBox.innerHTML = "";
                const resetMessage = document.createElement("div");
                resetMessage.className = "message bot-message";
                resetMessage.textContent = "Chat reiniciado.";
                chatBox.appendChild(resetMessage);
            } catch (error) {
                console.error("Error al reiniciar el chat:", error);
                alert("Error al reiniciar el chat.");
            }
        }
    </script>
</body>
</html>